<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>NestorBOT - Horarios</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    .header-titulo {
      text-align: center;
      background-color: #4b286d;
      color: #fff;
      padding: 15px 0;
      font-size: 1.3rem;
      margin-bottom: 10px;
    }
    .top-dias {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 10px;
    }
    .top-dias button {
      margin: 0 5px;
      padding: 6px 12px;
      cursor: pointer;
      background-color: #bbb;
      border: none;
      border-radius: 5px;
      color: #fff;
      font-weight: bold;
    }
    .top-dias button:hover {
      background-color: #999;
    }
    .top-dias button.activo {
      background-color: #666;
    }
    .top-global-buttons {
      text-align: center;
      margin-top: 10px;
    }
    .top-global-buttons button {
      cursor: pointer;
      background-color: #999;
      border: none;
      border-radius: 5px;
      color: #fff;
      font-weight: bold;
      padding: 6px 12px;
      margin: 0 5px;
    }
    .top-global-buttons button:hover {
      background-color: #666;
    }
    .sidebar-izquierda {
      width: 150px;
      float: left;
      padding: 10px;
      margin-left: 10px;
      background-color: #f8f8f8;
      border-right: 1px solid #ccc;
      min-height: 100vh;
    }
    .sidebar-boton {
      display: block;
      width: 100%;
      margin-bottom: 10px;
      text-align: center;
      text-decoration: none;
      border: 1px solid #aaa;
      border-radius: 5px;
      padding: 8px 0;
      color: #333;
      font-weight: bold;
      background-color: #eee;
      cursor: pointer;
    }
    .sidebar-boton-seleccionado {
      background-color: #75BBB0;
      color: #fff;
      border: none;
    }
    .sidebar-boton:hover {
      background-color: #65A4E3;
      color: #fff;
    }
    .contenedor-principal {
      margin-left: 180px;
      padding: 20px;
    }
    .horarios-contenedor {
      border: 1px solid #aaa;
      border-radius: 5px;
      padding: 10px;
      margin-top: 20px;
      margin-bottom: 20px;
      width: 90%;
    }
    .horarios-contenedor h2 {
      margin: 0 0 10px 0;
      font-size: 1.3rem;
      background-color: #4b286d;
      color: #fff;
      padding: 8px;
      border-radius: 4px;
      text-align: center;
    }
    .contenedor-botones-horarios {
      width: 100%;
      text-align: right;
      margin-bottom: 10px;
    }
    .boton-agregar {
      background-color: #75BBB0;
      border: none;
      color: #fff;
      font-size: 1rem;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 5px;
    }
    .boton-agregar:hover {
      background-color: #65A4E3;
    }
    .tabla-horarios {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
      table-layout: fixed;
    }
    .tabla-horarios th,
    .tabla-horarios td {
      border: 1px solid #ccc;
      padding: 6px;
      vertical-align: top;
      position: relative;
      text-align: center;
    }
    .col-hora {
      width: 4%;
      text-align: center;
      font-size: 0.9em;
    }
    .tabla-horarios thead th {
      font-size: 0.5em;
    }
    .editable {
      outline: 1px dotted transparent;
    }
    .editable:focus {
      outline: 1px dotted #aaa;
    }

    /* Bloques de profesor */
    .profesor-block {
      background-color: #FFD700;
      margin: 2px 0;
      border: 1px solid #aaa;
      border-radius: 4px;
      padding: 4px 6px;
      font-size: 0.5em;
      cursor: move;
      position: relative;
      user-select: none;
      display: block;
      width: 100%;
      box-sizing: border-box;
      text-align: center;
    }
    .ramo-line,
    .prof-line {
      display: block;
      margin: 2px 0;
      /* Quitamos contentEditable: ahora se edita desde el tooltip */
    }

    .recreo td {
      background-color: #eee !important;
      line-height: 0.2;
      height: 0.2em;
      min-height: 1px;
    }

    #colorPicker {
      display: none;
      position: absolute;
      z-index: 9999;
    }
    #profesorContainer {
      display: flex;
      flex-wrap: wrap;
      margin-top: 20px;
      width: 95%;
      border: 1px dashed #ccc;
      padding: 10px;
    }
    #profesorContainer button.boton-agregar {
      width: auto;
      margin-bottom: 10px;
    }
    .profesor-item {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-right: 15px;
      margin-bottom: 15px;
    }
    .profesor-item-icons {
      display: flex;
      flex-direction: row;
      gap: 6px;
      align-items: center; 
      justify-content: center;
      margin-top: 5px;
      width: 100%;
    }
    .profesor-item-icons img {
      width: 15px;
      height: 15px;
      cursor: pointer;
      display: inline-block;
      user-select: none;
    }
    .profesor-item-icons img:hover {
      opacity: 0.7;
    }
    .prof-count-span {
      font-size: 0.8em;
      margin-top: 4px;
      display: block;
      text-align: center;
      width: 100%;
    }

    .dia-contenedor {
      display: none !important;
    }
    .dia-contenedor.activo {
      display: block !important;
    }

    /* Resaltado */
    .prof-highlight-original {
      outline: 2px dashed yellow !important; 
      z-index: 2;
      position: relative;
    }
    .prof-highlight-other {
      outline: 2px dashed #222; 
      z-index: 2;
      position: relative;
    }
    .prof-faded {
      filter: grayscale(50%);
      opacity: 0.3;
    }

    /* Tooltip para edici√≥n */
    #editTooltip {
      position: absolute;
      width: 300px;
      background: #fff;
      border: 2px solid #333;
      display: none;
      padding: 10px;
      z-index: 10000;
      border-radius: 8px;
    }
    #editTooltip input {
      width: 90%;
      margin-bottom: 10px;
      font-size: 1em;
      padding: 5px;
    }
    #editTooltip label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    #editTooltip button {
      padding: 6px 12px;
      margin: 3px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    #saveTooltip {
      background-color: #75BBB0;
      color: #fff;
    }
    #cancelTooltip {
      background-color: #eeeeee;
    }
  </style>
</head>
<body>
  <div class="header-titulo">NestorBOT v2.3 - üìÖ Horarios</div>

  <div class="top-dias">
    <button id="btn-lunes" onclick="mostrarDia('lunes')">Lunes</button>
    <button id="btn-martes" onclick="mostrarDia('martes')">Martes</button>
    <button id="btn-miercoles" onclick="mostrarDia('miercoles')">Mi√©rcoles</button>
    <button id="btn-jueves" onclick="mostrarDia('jueves')">Jueves</button>
    <button id="btn-viernes" onclick="mostrarDia('viernes')">Viernes</button>
  </div>

  <div class="top-global-buttons">
    <button onclick="guardarEnJSON()">GUARDAR JSON</button>
    <button onclick="guardarExcelUnico()">DESCARGAR EXCEL</button>
  </div>

  <div class="sidebar-izquierda">
    <a href="conversor.html" class="sidebar-boton">‚ÜîÔ∏è Conversor</a>
    <a class="sidebar-boton sidebar-boton-seleccionado">üìÖ Horarios</a>
    <a class="sidebar-boton" href="index.html">üè† Men√∫ Principal</a>
  </div>

  <div class="contenedor-principal">
    <div id="dia-lunes" class="dia-contenedor">
      <div class="horarios-contenedor">
        <h2>Horario Lunes</h2>
        <div class="contenedor-botones-horarios">
          <button class="boton-agregar" onclick="agregarColumna()">Agregar Curso</button>
        </div>
        <table class="tabla-horarios" id="tablaHorarios-lunes">
          <thead>
            <tr id="filaCabeceras-lunes">
              <th class="col-hora">Hora</th>
            </tr>
          </thead>
          <tbody id="cuerpoTabla-lunes"></tbody>
        </table>
      </div>
    </div>
    
    <div id="dia-martes" class="dia-contenedor">
      <div class="horarios-contenedor">
        <h2>Horario Martes</h2>
        <div class="contenedor-botones-horarios">
          <button class="boton-agregar" onclick="agregarColumna()">Agregar Curso</button>
        </div>
        <table class="tabla-horarios" id="tablaHorarios-martes">
          <thead>
            <tr id="filaCabeceras-martes">
              <th class="col-hora">Hora</th>
            </tr>
          </thead>
          <tbody id="cuerpoTabla-martes"></tbody>
        </table>
      </div>
    </div>
    
    <div id="dia-miercoles" class="dia-contenedor">
      <div class="horarios-contenedor">
        <h2>Horario Mi√©rcoles</h2>
        <div class="contenedor-botones-horarios">
          <button class="boton-agregar" onclick="agregarColumna()">Agregar Curso</button>
        </div>
        <table class="tabla-horarios" id="tablaHorarios-miercoles">
          <thead>
            <tr id="filaCabeceras-miercoles">
              <th class="col-hora">Hora</th>
            </tr>
          </thead>
          <tbody id="cuerpoTabla-miercoles"></tbody>
        </table>
      </div>
    </div>
    
    <div id="dia-jueves" class="dia-contenedor">
      <div class="horarios-contenedor">
        <h2>Horario Jueves</h2>
        <div class="contenedor-botones-horarios">
          <button class="boton-agregar" onclick="agregarColumna()">Agregar Curso</button>
        </div>
        <table class="tabla-horarios" id="tablaHorarios-jueves">
          <thead>
            <tr id="filaCabeceras-jueves">
              <th class="col-hora">Hora</th>
            </tr>
          </thead>
          <tbody id="cuerpoTabla-jueves"></tbody>
        </table>
      </div>
    </div>
    
    <div id="dia-viernes" class="dia-contenedor">
      <div class="horarios-contenedor">
        <h2>Horario Viernes</h2>
        <div class="contenedor-botones-horarios">
          <button class="boton-agregar" onclick="agregarColumna()">Agregar Curso</button>
        </div>
        <table class="tabla-horarios" id="tablaHorarios-viernes">
          <thead>
            <tr id="filaCabeceras-viernes">
              <th class="col-hora">Hora</th>
            </tr>
          </thead>
          <tbody id="cuerpoTabla-viernes"></tbody>
        </table>
      </div>
    </div>

    <div id="profesorContainer">
      <button class="boton-agregar" onclick="crearProfesor()">Agregar Profe</button>
    </div>
  </div>

  <input type="color" id="colorPicker" oninput="cambiarColor(event)" onclick="event.stopPropagation()" />

  <!-- Tooltip de edici√≥n de bloque -->
  <div id="editTooltip">
    <label>Ramo:</label>
    <input id="inputRamo" type="text" />
    <label>Profesor:</label>
    <input id="inputProf" type="text" />
    <br/>
    <button id="saveTooltip">Guardar</button>
    <button id="cancelTooltip">Cancelar</button>
  </div>

  <!-- Librer√≠a para exportar a Excel (opcional) -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <script>
    let isReconstructing = false;
    const BLOQUES = [
      { label: "08:15", isBreak: false },
      { label: "09:00", isBreak: false },
      { label: "",      isBreak: true },
      { label: "10:00", isBreak: false },
      { label: "10:45", isBreak: false },
      { label: "",      isBreak: true },
      { label: "11:45", isBreak: false },
      { label: "12:30", isBreak: false },
      { label: "",      isBreak: true },
      { label: "14:00", isBreak: false },
      { label: "14:45", isBreak: false },
      { label: "",      isBreak: true },
      { label: "15:45", isBreak: false },
      { label: "16:30", isBreak: false },
      { label: "17:15", isBreak: false },
      { label: "18:00", isBreak: false },
      { label: "18:45", isBreak: false }
    ];
    const dias = ["lunes","martes","miercoles","jueves","viernes"];

    let columnasGlobales = [];
    let colorPicker = null;
    let profSeleccionado = null;
    let profesorCounter = 0;
    let profesoresGuardados = [];
    let selectedBlock = null;

    // Asocia profId => n√∫mero de bloques en el horario
    const profBlockCount = {};

    window.onload = async function() {
      colorPicker = document.getElementById('colorPicker');
      dias.forEach(d => generarHorasParaDia(d));
      // Intentar cargar desde localStorage
      const savedData = localStorage.getItem('horariosData');
      if (savedData) {
        try {
          const data = JSON.parse(savedData);
          reconstruirDesdeJSON(data);
        } catch (e) {
          console.error("Error parsing saved data:", e);
          columnasGlobales = [];
        }
      } else {
        // Intentar cargar un horarios.json
        try {
          let resp = await fetch("./horarios.json", { cache: 'no-store' });
          if (!resp.ok) throw new Error("No existe archivo");
          let data = await resp.json();
          reconstruirDesdeJSON(data);
        } catch(e) {
          columnasGlobales = [];
        }
      }
      mostrarDia("lunes");
    };

    window.addEventListener('beforeunload', () => {
      const data = construirJSONCompleto();
      localStorage.setItem('horariosData', JSON.stringify(data));
    });

    function generarHorasParaDia(dia) {
      let cuerpo = document.getElementById(`cuerpoTabla-${dia}`);
      BLOQUES.forEach(b => {
        let fila = document.createElement('tr');
        if (b.isBreak) fila.classList.add('recreo');
        let tdHora = document.createElement('td');
        tdHora.classList.add('col-hora');
        tdHora.style.pointerEvents = 'none';
        tdHora.textContent = b.label;
        fila.appendChild(tdHora);
        cuerpo.appendChild(fila);
      });
    }

    function mostrarDia(dia) {
      dias.forEach(d => {
        let contenedor = document.getElementById(`dia-${d}`);
        let btnDia = document.getElementById(`btn-${d}`);
        if (!contenedor) return;
        if (d === dia) {
          contenedor.classList.add('activo');
          btnDia.classList.add('activo');
        } else {
          contenedor.classList.remove('activo');
          btnDia.classList.remove('activo');
        }
      });
    }

    function agregarColumna(nombreCurso = "") {
      if (!nombreCurso && !isReconstructing) {
        nombreCurso = "Nuevo Curso " + (columnasGlobales.length + 1);
        columnasGlobales.push(nombreCurso);
      } else if (nombreCurso && !isReconstructing) {
        columnasGlobales.push(nombreCurso);
      }
      dias.forEach(dia => {
        let filaCabeceras = document.getElementById(`filaCabeceras-${dia}`);
        if (!filaCabeceras) return;
        let nuevoTh = document.createElement('th');
        nuevoTh.classList.add('editable');
        nuevoTh.contentEditable = "true";
        nuevoTh.textContent = nombreCurso;
        filaCabeceras.appendChild(nuevoTh);

        let cuerpo = document.getElementById(`cuerpoTabla-${dia}`);
        if (!cuerpo) return;
        let filas = cuerpo.getElementsByTagName('tr');
        for (let i = 0; i < filas.length; i++) {
          let nuevaTd = document.createElement('td');
          if (!filas[i].classList.contains('recreo')) {
            nuevaTd.ondragover = allowDrop;
            nuevaTd.ondrop = ev => drop(ev, dia);
          }
          filas[i].appendChild(nuevaTd);
        }
      });
    }

    function crearProfesor() {
      let profesorItem = document.createElement('div');
      profesorItem.classList.add('profesor-item');

      // Bloque "plantilla" del profesor
      let profesorBlock = document.createElement('div');
      profesorBlock.classList.add('profesor-block');
      profesorBlock.draggable = true;
      profesorBlock.ondragstart = dragStart;
      profesorBlock.ondragend = dragEnd;
      
      // Editar con tooltip al hacer doble click
      profesorBlock.ondblclick = e => {
        e.stopPropagation();
        openBlockEditor(profesorBlock, e.pageX, e.pageY);
      };

      // L√≠neas de texto (NO contentEditable, se modifican via tooltip)
      let ramoLine = document.createElement('div');
      ramoLine.classList.add('ramo-line');
      ramoLine.textContent = "Ramo " + (profesorCounter + 1);

      let profLine = document.createElement('div');
      profLine.classList.add('prof-line');
      profLine.textContent = "Prof. " + (++profesorCounter);

      profesorBlock.appendChild(ramoLine);
      profesorBlock.appendChild(profLine);

      // Un ID √∫nico para este profesor (todos sus clones lo compartir√°n)
      let uniqueId = "prof_" + Date.now();
      profesorBlock.dataset.profId = uniqueId;
      profBlockCount[uniqueId] = 0; // inicial

      let iconContainer = document.createElement('div');
      iconContainer.classList.add('profesor-item-icons');

      let colorIcon = document.createElement('img');
      colorIcon.src = "https://cdn-icons-png.flaticon.com/512/2917/2917995.png";
      colorIcon.title = "Cambiar color";
      colorIcon.onclick = ev => {
        profSeleccionado = profesorBlock;
        colorPicker.style.display = 'block';
        colorPicker.style.left = ev.pageX + 'px';
        colorPicker.style.top = ev.pageY + 'px';
        ev.stopPropagation();
      };

      let trashIcon = document.createElement('img');
      trashIcon.src = "https://cdn-icons-png.flaticon.com/512/3096/3096673.png";
      trashIcon.title = "Eliminar profesor";
      trashIcon.onclick = () => {
        // quitar su conteo
        delete profBlockCount[uniqueId];
        profesorItem.remove();
      };

      iconContainer.appendChild(colorIcon);
      iconContainer.appendChild(trashIcon);

      // Contador de bloques
      let blockCountSpan = document.createElement('span');
      blockCountSpan.classList.add('prof-count-span');
      blockCountSpan.textContent = "0"; // inicia en 0

      profesorItem.appendChild(profesorBlock);
      profesorItem.appendChild(iconContainer);
      profesorItem.appendChild(blockCountSpan);

      document.getElementById('profesorContainer').appendChild(profesorItem);
    }

    // Funci√≥n para abrir el "tooltip" de edici√≥n
    function openBlockEditor(block, x, y) {
      let tooltip = document.getElementById('editTooltip');
      tooltip.style.left = x + 'px';
      tooltip.style.top = y + 'px';
      tooltip.style.display = 'block';

      let ramoLine = block.querySelector('.ramo-line');
      let profLine = block.querySelector('.prof-line');

      document.getElementById('inputRamo').value = ramoLine.textContent.trim();
      document.getElementById('inputProf').value = profLine.textContent.trim();

      document.getElementById('saveTooltip').onclick = function() {
        ramoLine.textContent = document.getElementById('inputRamo').value;
        profLine.textContent = document.getElementById('inputProf').value;
        tooltip.style.display = 'none';
      };

      document.getElementById('cancelTooltip').onclick = function() {
        tooltip.style.display = 'none';
      };
    }

    let draggedFromContainer = false;

    function dragStart(e) {
      e.dataTransfer.effectAllowed = "copy";
      e.dataTransfer.setData("text/plain", e.target.id);
      draggedFromContainer = this.parentNode && this.parentNode.classList && this.parentNode.classList.contains('profesor-item');
      if (!this.id) {
        this.id = 'prof_' + Date.now();
      }
      profSeleccionado = this;
    }

    function dragEnd() {
      dias.forEach(d => checkAllRowsForConflicts(d));
    }

    function allowDrop(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = "copy";
    }

    function drop(e, dia) {
      e.preventDefault();

      // Impedir "anidar" un bloque dentro de otro
      if (e.target.classList.contains('profesor-block')) return; 
      if (e.target.closest('.profesor-block')) return;

      let id = e.dataTransfer.getData("text/plain");
      let element = document.getElementById(id);
      if (!element) return;

      let profId = element.dataset.profId;

      if (draggedFromContainer) {
        // Se clona un "nuevo" bloque de este profesor
        let clone = element.cloneNode(true);
        clone.id = "prof_" + Date.now() + "_clone";
        clone.draggable = true;
        clone.ondragstart = dragStart;
        clone.ondragend = dragEnd;
        clone.ondblclick = ev => {
          ev.stopPropagation();
          openBlockEditor(clone, ev.pageX, ev.pageY);
        };
        // Mantener el mismo profId
        clone.dataset.profId = profId;

        e.target.appendChild(clone);

        // Aumentar el conteo de bloques
        profBlockCount[profId]++;
        updateProfessorCount(profId);
      } else {
        // Mover el bloque actual dentro del horario
        e.target.appendChild(element);
      }

      draggedFromContainer = false;
      let row = e.target.closest('tr');
      if (row) checkRowConflicts(row);
    }

    function cambiarColor(e) {
      if (profSeleccionado) {
        profSeleccionado.style.backgroundColor = e.target.value;
      }
      colorPicker.style.display = 'none';
    }

    // --- Clicks generales
    document.addEventListener('click', e => {
      let block = e.target.closest('.profesor-block');
      let inHorario = block?.closest('tbody');
      if (block && inHorario) {
        selectedBlock = block;
        highlightSameProfessor(selectedBlock);
      } else {
        clearHighlight();
      }
      // Oculta el colorPicker si hacemos click fuera
      if (
        colorPicker.style.display === 'block' &&
        !colorPicker.contains(e.target) &&
        profSeleccionado &&
        !profSeleccionado.contains(e.target)
      ) {
        colorPicker.style.display = 'none';
        profSeleccionado = null;
      }
    });

    // --- Tecla SUPR
    document.addEventListener('keydown', e => {
      if (e.key === "Delete" || e.keyCode === 46) {
        if (selectedBlock && selectedBlock.parentNode) {
          let pId = selectedBlock.dataset.profId;
          if (pId && profBlockCount[pId] > 0) {
            profBlockCount[pId]--;
            updateProfessorCount(pId);
          }
          selectedBlock.parentNode.removeChild(selectedBlock);
          clearHighlight();
        }
      }
    });

    // --- Conflictos (chocan celdas con mismo prof)
    function checkRowConflicts(row) {
      let tds = row.querySelectorAll('td');
      tds.forEach(td => td.style.backgroundColor = "");
      let profesorMap = new Map();
      tds.forEach(td => {
        let blocks = td.querySelectorAll('.profesor-block');
        blocks.forEach(block => {
          let profLine = block.querySelector('.prof-line');
          if (profLine) {
            let nombreProf = profLine.textContent.trim().toLowerCase();
            if (!profesorMap.has(nombreProf)) {
              profesorMap.set(nombreProf, []);
            }
            profesorMap.get(nombreProf).push(td);
          }
        });
      });
      profesorMap.forEach(celdas => {
        if (celdas.length > 1) {
          celdas.forEach(td => {
            td.style.backgroundColor = "red";
          });
        }
      });
    }

    function checkAllRowsForConflicts(dia) {
      let filas = document.querySelectorAll(`#cuerpoTabla-${dia} tr`);
      filas.forEach(fila => checkRowConflicts(fila));
    }

    function rgbToHex(colorStr) {
      let match = colorStr.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
      if (!match) return null;
      let r = parseInt(match[1], 10);
      let g = parseInt(match[2], 10);
      let b = parseInt(match[3], 10);
      let hex = ((r << 16) | (g << 8) | b).toString(16).toUpperCase();
      return ("000000" + hex).slice(-6);
    }

    function guardarExcelUnico() {
      let wb = XLSX.utils.book_new();
      dias.forEach(dia => {
        let tabla = document.getElementById(`tablaHorarios-${dia}`);
        if (!tabla) return;
        let ws = tableToSheetConEstilos(tabla);
        XLSX.utils.book_append_sheet(wb, ws, dia.toUpperCase());
      });
      XLSX.writeFile(wb, "horarios-completos.xlsx");
    }

    function tableToSheetConEstilos(tabla) {
      let aoa = [];
      let rows = tabla.querySelectorAll("tr");
      for (let r = 0; r < rows.length; r++) {
        let rowData = [];
        let cells = rows[r].querySelectorAll("th, td");
        for (let c = 0; c < cells.length; c++) {
          let cellEl = cells[c];
          let cellText = cellEl.textContent.trim();
          let styleObj = {};
          let bgColor = window.getComputedStyle(cellEl).backgroundColor;
          if (bgColor && bgColor !== "rgba(0, 0, 0, 0)" && bgColor !== "transparent") {
            let hex = rgbToHex(bgColor);
            if (hex) {
              styleObj.fill = { patternType: "solid", fgColor: { rgb: hex } };
            }
          }
          let cellObj = { t: 's', v: cellText };
          if (Object.keys(styleObj).length > 0) {
            cellObj.s = styleObj;
          }
          rowData.push(cellObj);
        }
        aoa.push(rowData);
      }
      return XLSX.utils.aoa_to_sheet(aoa);
    }

    function guardarEnJSON() {
      let data = construirJSONCompleto();
      let jsonStr = JSON.stringify(data, null, 2);
      descargarArchivo(jsonStr, "horarios.json", "application/json");
      localStorage.setItem('horariosData', JSON.stringify(data));
    }

    function construirJSONCompleto() {
      let data = { columnas: columnasGlobales.slice(), dias: {}, profesores: [] };
      dias.forEach(dia => {
        let tabla = document.getElementById(`tablaHorarios-${dia}`);
        if (!tabla) return;
        let filas = tabla.querySelectorAll("tbody tr");
        let dayMatrix = [];
        for (let i = 0; i < filas.length; i++) {
          let celdas = filas[i].querySelectorAll("td");
          let rowInfo = [];
          for (let j = 0; j < celdas.length; j++) {
            let cellData = [];
            let blocks = celdas[j].querySelectorAll(".profesor-block");
            blocks.forEach(block => {
              let ramoLine = block.querySelector(".ramo-line")?.textContent.trim() || "";
              let profLine = block.querySelector(".prof-line")?.textContent.trim() || "";
              let bgColor = window.getComputedStyle(block).backgroundColor;
              let hexColor = null;
              if (bgColor && bgColor !== "rgba(0, 0, 0, 0)" && bgColor !== "transparent") {
                hexColor = rgbToHex(bgColor);
              }
              cellData.push({ ramo: ramoLine, prof: profLine, color: hexColor });
            });
            rowInfo.push(cellData);
          }
          dayMatrix.push(rowInfo);
        }
        data.dias[dia] = dayMatrix;
      });

      let profItems = document.querySelectorAll("#profesorContainer .profesor-item");
      profItems.forEach(item => {
        let block = item.querySelector(".profesor-block");
        let ramo = block.querySelector(".ramo-line")?.textContent.trim() || "";
        let prof = block.querySelector(".prof-line")?.textContent.trim() || "";
        let bgColor = window.getComputedStyle(block).backgroundColor;
        let hex = null;
        if (bgColor && bgColor !== "rgba(0, 0, 0, 0)" && bgColor !== "transparent") {
          hex = rgbToHex(bgColor);
        }
        // Tomamos el conteo desde profBlockCount en vez de un input
        let profId = block.dataset.profId;
        let count = profBlockCount[profId] || 0;

        data.profesores.push({
          ramo: ramo,
          prof: prof,
          color: hex,
          blockCount: count.toString()
        });
      });
      return data;
    }

    function reconstruirDesdeJSON(data) {
      isReconstructing = true;
      columnasGlobales = data.columnas ? [...data.columnas] : [];
      dias.forEach(dia => {
        let tabla = document.getElementById(`tablaHorarios-${dia}`);
        if (!tabla) return;
        let filaCabeceras = tabla.querySelector("thead tr");
        while (filaCabeceras.children.length > 1) {
          filaCabeceras.removeChild(filaCabeceras.lastChild);
        }
        let tbody = tabla.querySelector("tbody");
        tbody.innerHTML = "";
        BLOQUES.forEach(b => {
          let fila = document.createElement('tr');
          if (b.isBreak) fila.classList.add('recreo');
          let tdHora = document.createElement('td');
          tdHora.classList.add('col-hora');
          tdHora.style.pointerEvents = 'none';
          tdHora.textContent = b.label;
          fila.appendChild(tdHora);
          tbody.appendChild(fila);
        });
      });
      for (let colName of columnasGlobales) {
        agregarColumna(colName);
      }
      for (let dia in data.dias) {
        let dayMatrix = data.dias[dia];
        let tabla = document.getElementById(`tablaHorarios-${dia}`);
        if (!tabla) continue;
        let filas = tabla.querySelectorAll("tbody tr");
        for (let i = 0; i < dayMatrix.length; i++) {
          if (i >= filas.length) break;
          let rowCells = dayMatrix[i];
          let celdas = filas[i].querySelectorAll("td");
          for (let j = 0; j < rowCells.length; j++) {
            if (j >= celdas.length) break;
            let blocksInfo = rowCells[j];
            blocksInfo.forEach(binfo => {
              let block = document.createElement("div");
              block.classList.add("profesor-block");
              block.draggable = true;
              block.ondragstart = dragStart;
              block.ondragend = dragEnd;
              block.ondblclick = ev => {
                ev.stopPropagation();
                openBlockEditor(block, ev.pageX, ev.pageY);
              };
              let ramoLine = document.createElement('div');
              ramoLine.classList.add('ramo-line');
              ramoLine.textContent = binfo.ramo || "";
              let profLine = document.createElement('div');
              profLine.classList.add('prof-line');
              profLine.textContent = binfo.prof || "";
              block.appendChild(ramoLine);
              block.appendChild(profLine);
              if (binfo.color) {
                block.style.backgroundColor = "#" + binfo.color;
              }
              celdas[j].appendChild(block);
            });
          }
        }
      }

      let profContainer = document.getElementById("profesorContainer");
      profContainer.querySelectorAll(".profesor-item").forEach(p => p.remove());

      if (data.profesores) {
        data.profesores.forEach(p => {
          let profesorItem = document.createElement("div");
          profesorItem.classList.add("profesor-item");

          let profesorBlock = document.createElement("div");
          profesorBlock.classList.add("profesor-block");
          profesorBlock.draggable = true;
          profesorBlock.ondragstart = dragStart;
          profesorBlock.ondragend = dragEnd;
          profesorBlock.ondblclick = ev => {
            ev.stopPropagation();
            openBlockEditor(profesorBlock, ev.pageX, ev.pageY);
          };

          let ramoLine = document.createElement("div");
          ramoLine.classList.add("ramo-line");
          ramoLine.textContent = p.ramo || "";
          let profLine = document.createElement("div");
          profLine.classList.add("prof-line");
          profLine.textContent = p.prof || "";

          profesorBlock.appendChild(ramoLine);
          profesorBlock.appendChild(profLine);

          if (p.color) {
            profesorBlock.style.backgroundColor = "#" + p.color;
          }
          // Generamos un nuevo profId y seteamos el contador
          let uniqueId = "prof_" + Date.now() + "_" + Math.floor(Math.random()*10000);
          profesorBlock.dataset.profId = uniqueId;
          profBlockCount[uniqueId] = parseInt(p.blockCount || "0",10);

          let iconContainer = document.createElement("div");
          iconContainer.classList.add("profesor-item-icons");

          let colorIcon = document.createElement("img");
          colorIcon.src = "https://cdn-icons-png.flaticon.com/512/2917/2917995.png";
          colorIcon.title = "Cambiar color";
          colorIcon.onclick = ev => {
            profSeleccionado = profesorBlock;
            colorPicker.style.display = 'block';
            colorPicker.style.left = ev.pageX + 'px';
            colorPicker.style.top = ev.pageY + 'px';
            ev.stopPropagation();
          };

          let trashIcon = document.createElement("img");
          trashIcon.src = "https://cdn-icons-png.flaticon.com/512/3096/3096673.png";
          trashIcon.title = "Eliminar profesor";
          trashIcon.onclick = () => {
            delete profBlockCount[uniqueId];
            profesorItem.remove();
          };

          iconContainer.appendChild(colorIcon);
          iconContainer.appendChild(trashIcon);

          let blockCountSpan = document.createElement('span');
          blockCountSpan.classList.add('prof-count-span');
          blockCountSpan.textContent = profBlockCount[uniqueId].toString();

          profesorItem.appendChild(profesorBlock);
          profesorItem.appendChild(iconContainer);
          profesorItem.appendChild(blockCountSpan);

          profContainer.appendChild(profesorItem);
        });
      }
      isReconstructing = false;
    }

    function descargarArchivo(dataStr, fileName, mimeType) {
      let blob = new Blob([dataStr], { type: mimeType });
      let url = URL.createObjectURL(blob);
      let a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function highlightSameProfessor(block) {
      let profLine = block.querySelector('.prof-line');
      if (!profLine) return;
      let profName = profLine.textContent.trim().toLowerCase();
      let allBlocks = document.querySelectorAll('tbody .profesor-block');
      allBlocks.forEach(b => {
        b.classList.remove('prof-highlight-original','prof-highlight-other','prof-faded');
        let bName = b.querySelector('.prof-line')?.textContent.trim().toLowerCase();
        if (bName === profName) {
          if (b === block) {
            b.classList.add('prof-highlight-original');
          } else {
            b.classList.add('prof-highlight-other');
          }
        } else {
          b.classList.add('prof-faded');
        }
      });
    }

    function clearHighlight() {
      selectedBlock = null;
      let allBlocks = document.querySelectorAll('tbody .profesor-block');
      allBlocks.forEach(b => {
        b.classList.remove('prof-highlight-original','prof-highlight-other','prof-faded');
      });
    }

    function updateProfessorCount(profId) {
      const container = document.getElementById("profesorContainer");
      const theBlock = container.querySelector(`.profesor-block[data-prof-id="${profId}"]`);
      if (!theBlock) return;
      const profesorItem = theBlock.closest(".profesor-item");
      if (!profesorItem) return;
      const span = profesorItem.querySelector(".prof-count-span");
      if (!span) return;
      span.textContent = profBlockCount[profId].toString();
    }
  </script>
</body>
</html>