<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>NestorBOT - Horarios</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    .header-titulo {
      text-align: center;
      background-color: #4b286d;
      color: #fff;
      padding: 15px 0;
      font-size: 1.3rem;
      margin-bottom: 10px;
    }

    /* Barra superior con botones de días */
    .top-dias {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 10px;
    }
    .top-dias button {
      margin: 0 5px;
      padding: 6px 12px;
      cursor: pointer;
      background-color: #bbb;
      border: none;
      border-radius: 5px;
      color: #fff;
      font-weight: bold;
    }
    .top-dias button:hover {
      background-color: #999;
    }
    /* Botón de día activo */
    .top-dias button.activo {
      background-color: #666;
    }

    /* Sidebar a la izquierda */
    .sidebar-izquierda {
      width: 150px;
      float: left;
      padding: 10px;
      margin-left: 10px;
      background-color: #f8f8f8;
      border-right: 1px solid #ccc;
      min-height: 100vh;
    }
    .sidebar-boton {
      display: block;
      width: 100%;
      margin-bottom: 10px;
      text-align: center;
      text-decoration: none;
      border: 1px solid #aaa;
      border-radius: 5px;
      padding: 8px 0;
      color: #333;
      font-weight: bold;
      background-color: #eee;
      cursor: pointer;
    }
    .sidebar-boton-seleccionado {
      background-color: #75BBB0;
      color: #fff;
      border: none;
    }
    .sidebar-boton:hover {
      background-color: #65A4E3;
      color: #fff;
    }

    .contenedor-principal {
      margin-left: 180px;
      padding: 20px;
      display: block; /* Contendrá varios subcontenedores (uno por día + contenedor de profes) */
    }

    /* Contenedor principal para la sección de Horarios */
    .horarios-contenedor {
      border: 1px solid #aaa;
      border-radius: 5px;
      padding: 10px;
      margin-top: 20px;
      margin-bottom: 20px;
      width: 90%;
    }
    .horarios-contenedor h2 {
      margin: 0 0 10px 0;
      font-size: 1.3rem;
      background-color: #4b286d;
      color: #fff;
      padding: 8px;
      border-radius: 4px;
      text-align: center;
    }

    .contenedor-botones-horarios {
      width: 100%;
      text-align: right;
      margin-bottom: 10px;
    }
    .boton-agregar {
      background-color: #75BBB0;
      border: none;
      color: #fff;
      font-size: 1rem;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 5px;
    }
    .boton-agregar:hover {
      background-color: #65A4E3;
    }

    .tabla-horarios {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
      table-layout: fixed;
    }
    .tabla-horarios th,
    .tabla-horarios td {
      border: 1px solid #ccc;
      padding: 6px;
      vertical-align: top;
      position: relative;
      text-align: center;
    }
    .col-hora {
      width: 15%;
      text-align: center;
      font-size: 0.7em;
    }
    .tabla-horarios thead th {
      font-size: 0.5em;
    }

    .editable {
      outline: 1px dotted transparent;
    }
    .editable:focus {
      outline: 1px dotted #aaa;
    }

    /* Bloques profesor */
    .profesor-block {
      background-color: #FFD700;
      margin: 5px;
      border: 1px solid #aaa;
      border-radius: 4px;
      padding: 4px 6px;
      font-size: 0.5em;
      cursor: move;
      position: relative;
      user-select: none; /* Evita seleccionar texto al arrastrar */
      display: inline-block;
    }
    .profesor-block .ramo-line,
    .profesor-block .prof-line {
      display: block;
      width: 100%;
      min-height: 12px;
    }

    /* celdas de recreo en gris, altura menor (x0.2 aprox) */
    .recreo td {
      background-color: #eee !important;
      line-height: 0.2;
      height: 0.2em;
      min-height: 1px; /* Ajustar según se requiera */
    }

    /* colorPicker tooltip */
    #colorPicker {
      display: none;
      position: absolute;
      z-index: 9999;
    }

    /* Container para los profesores: horizontal flex-wrap */
    #profesorContainer {
      display: flex;
      flex-wrap: wrap; /* Para que bajen a la siguiente línea si son muchos */
      margin-top: 20px;
      width: 95%;
      border: 1px dashed #ccc;
      padding: 10px;
    }
    #profesorContainer button.boton-agregar {
      width: auto;
      margin-bottom: 10px;
    }

    /* item que contiene al block y al input debajo */
    .profesor-item {
      display: flex;
      flex-direction: column; /* Bloque arriba, input abajo */
      align-items: flex-start;
      margin-right: 15px;
      margin-bottom: 15px;
    }

    /* Cada día como un "tab" de contenido que se oculta/muestra */
    .dia-contenedor {
      display: none; /* Por defecto oculto */
    }
    .dia-contenedor.activo {
      display: block;
    }
  </style>
</head>
<body>
  <div class="header-titulo">NestorBOT v2.0 - Horarios</div>

  <!-- Barra superior con 5 botones de días -->
  <div class="top-dias">
    <button id="btn-lunes" onclick="mostrarDia('lunes')">Lunes</button>
    <button id="btn-martes" onclick="mostrarDia('martes')">Martes</button>
    <button id="btn-miercoles" onclick="mostrarDia('miercoles')">Miércoles</button>
    <button id="btn-jueves" onclick="mostrarDia('jueves')">Jueves</button>
    <button id="btn-viernes" onclick="mostrarDia('viernes')">Viernes</button>
  </div>

  <!-- Sidebar Izquierda -->
  <div class="sidebar-izquierda">
    <a href="conversor.html" class="sidebar-boton">Conversor</a>
    <a class="sidebar-boton sidebar-boton-seleccionado">Horarios</a>
    <a class="sidebar-boton" href="index.html">Menú Principal</a>
  </div>

  <div class="contenedor-principal">
    <!-- Cada día es un contenedor distinto -->
    <div id="dia-lunes" class="dia-contenedor">
      <div class="horarios-contenedor">
        <h2>Horario Lunes</h2>
        <div class="contenedor-botones-horarios">
          <button class="boton-agregar" onclick="agregarColumna()">Agregar Curso</button>
          <button class="boton-agregar" onclick="guardarExcel('lunes')">Guardar Excel</button>
        </div>
        <table class="tabla-horarios" id="tablaHorarios-lunes">
          <thead>
            <tr id="filaCabeceras-lunes">
              <th class="col-hora">Hora</th>
            </tr>
          </thead>
          <tbody id="cuerpoTabla-lunes"></tbody>
        </table>
      </div>
    </div>

    <div id="dia-martes" class="dia-contenedor">
      <div class="horarios-contenedor">
        <h2>Horario Martes</h2>
        <div class="contenedor-botones-horarios">
          <button class="boton-agregar" onclick="agregarColumna()">Agregar Curso</button>
          <button class="boton-agregar" onclick="guardarExcel('martes')">Guardar Excel</button>
        </div>
        <table class="tabla-horarios" id="tablaHorarios-martes">
          <thead>
            <tr id="filaCabeceras-martes">
              <th class="col-hora">Hora</th>
            </tr>
          </thead>
          <tbody id="cuerpoTabla-martes"></tbody>
        </table>
      </div>
    </div>

    <div id="dia-miercoles" class="dia-contenedor">
      <div class="horarios-contenedor">
        <h2>Horario Miércoles</h2>
        <div class="contenedor-botones-horarios">
          <button class="boton-agregar" onclick="agregarColumna()">Agregar Curso</button>
          <button class="boton-agregar" onclick="guardarExcel('miercoles')">Guardar Excel</button>
        </div>
        <table class="tabla-horarios" id="tablaHorarios-miercoles">
          <thead>
            <tr id="filaCabeceras-miercoles">
              <th class="col-hora">Hora</th>
            </tr>
          </thead>
          <tbody id="cuerpoTabla-miercoles"></tbody>
        </table>
      </div>
    </div>

    <div id="dia-jueves" class="dia-contenedor">
      <div class="horarios-contenedor">
        <h2>Horario Jueves</h2>
        <div class="contenedor-botones-horarios">
          <button class="boton-agregar" onclick="agregarColumna()">Agregar Curso</button>
          <button class="boton-agregar" onclick="guardarExcel('jueves')">Guardar Excel</button>
        </div>
        <table class="tabla-horarios" id="tablaHorarios-jueves">
          <thead>
            <tr id="filaCabeceras-jueves">
              <th class="col-hora">Hora</th>
            </tr>
          </thead>
          <tbody id="cuerpoTabla-jueves"></tbody>
        </table>
      </div>
    </div>

    <div id="dia-viernes" class="dia-contenedor">
      <div class="horarios-contenedor">
        <h2>Horario Viernes</h2>
        <div class="contenedor-botones-horarios">
          <button class="boton-agregar" onclick="agregarColumna()">Agregar Curso</button>
          <button class="boton-agregar" onclick="guardarExcel('viernes')">Guardar Excel</button>
        </div>
        <table class="tabla-horarios" id="tablaHorarios-viernes">
          <thead>
            <tr id="filaCabeceras-viernes">
              <th class="col-hora">Hora</th>
            </tr>
          </thead>
          <tbody id="cuerpoTabla-viernes"></tbody>
        </table>
      </div>
    </div>

    <!-- Contenedor de profesores (abajo) -->
    <div id="profesorContainer">
      <button class="boton-agregar" onclick="crearProfesor()">Agregar Profe</button>
    </div>
  </div>

  <!-- colorPicker para cambiar color al profesor -->
  <input type="color" id="colorPicker" oninput="cambiarColor(event)" onclick="event.stopPropagation()" />

  <!-- Librería para exportar a Excel (SheetJS) -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <script>
    /*
      1) Horas y recreos: se generan en cada tabla (lunes a viernes).
      2) Columnas (cursos) deben ser constantes en todos los días.
         -> Llevamos un array global de columnas. Al "agregarColumna" (nuevo curso),
            se añade a este array y se actualizan todos los días.
    */

    // Estructura de bloques de tiempo
    const BLOQUES = [
      { label: "08:15", isBreak: false },
      { label: "09:00", isBreak: false },
      // recreo 9:45-10:00
      { label: "",      isBreak: true  },
      { label: "10:00", isBreak: false },
      { label: "10:45", isBreak: false },
      // recreo 11:30-11:45
      { label: "",      isBreak: true  },
      { label: "11:45", isBreak: false },
      { label: "12:30", isBreak: false },
      // recreo 13:15-14:00
      { label: "",      isBreak: true  },
      { label: "14:00", isBreak: false },
      { label: "14:45", isBreak: false },
      // recreo 15:30-15:45
      { label: "",      isBreak: true  },
      { label: "15:45", isBreak: false },
      { label: "16:30", isBreak: false },
      { label: "17:15", isBreak: false },
      { label: "18:00", isBreak: false },
      { label: "18:45", isBreak: false }
    ];

    // Días disponibles
    const dias = ["lunes", "martes", "miercoles", "jueves", "viernes"];

    // Array global de columnas (cursos)
    let columnasGlobales = [];

    window.onload = function(){
      // Generar horas en cada tabla
      dias.forEach(d => generarHorasParaDia(d));
      // Mostrar lunes por defecto
      mostrarDia("lunes");
    };

    // Generar la parte de las horas y recreos para la tabla de un día
    function generarHorasParaDia(dia) {
      let cuerpo = document.getElementById(`cuerpoTabla-${dia}`);
      BLOQUES.forEach(b => {
        let fila = document.createElement('tr');
        if (b.isBreak) {
          fila.classList.add('recreo');
        }
        let tdHora = document.createElement('td');
        tdHora.classList.add('col-hora');
        tdHora.style.pointerEvents = 'none';
        tdHora.textContent = b.label; 
        fila.appendChild(tdHora);
        cuerpo.appendChild(fila);
      });
    }

    // Mostrar un día y ocultar el resto, además marcar botón activo
    function mostrarDia(dia) {
      dias.forEach(d => {
        const contenedor = document.getElementById(`dia-${d}`);
        const btnDia = document.getElementById(`btn-${d}`);
        if(d===dia) {
          contenedor.classList.add('activo');
          btnDia.classList.add('activo');
        } else {
          contenedor.classList.remove('activo');
          btnDia.classList.remove('activo');
        }
      });
    }

    // Agregar un nuevo curso (columna) a TODAS las tablas
    function agregarColumna() {
      // Nombre por defecto
      let nombreCurso = "Nuevo Curso " + (columnasGlobales.length + 1);

      // Añadir a array global
      columnasGlobales.push(nombreCurso);

      // Para cada día, agregamos un TH y una TD para cada fila
      dias.forEach(dia => {
        let filaCabeceras = document.getElementById(`filaCabeceras-${dia}`);
        let nuevoTh = document.createElement('th');
        nuevoTh.classList.add('editable');
        nuevoTh.contentEditable = "true";
        nuevoTh.textContent = nombreCurso;
        filaCabeceras.appendChild(nuevoTh);

        let cuerpo = document.getElementById(`cuerpoTabla-${dia}`);
        let filas = cuerpo.getElementsByTagName('tr');
        for (let i = 0; i < filas.length; i++) {
          let nuevaTd = document.createElement('td');
          if (!filas[i].classList.contains('recreo')) {
            nuevaTd.ondragover = allowDrop;
            // Asignar la misma función drop, con el "dia"
            nuevaTd.ondrop = (ev) => drop(ev, dia);
          }
          filas[i].appendChild(nuevaTd);
        }
      });
    }

    let colorPicker = document.getElementById('colorPicker');
    let profSeleccionado = null;
    let profesorCounter = 0;

    /*
      Crear profesor 
        - Contenedor (.profesor-item) con "flex-direction: column"
        - Arriba: Bloque con 2 líneas + ícono color
        - Debajo: input de número de bloques
    */
    function crearProfesor() {
      let profesorItem = document.createElement('div');
      profesorItem.classList.add('profesor-item');

      // Bloque con 2 líneas + ícono de color
      let profesorBlock = document.createElement('div');
      profesorBlock.classList.add('profesor-block');
      profesorBlock.draggable = true;
      profesorBlock.ondragstart = dragStart;
      profesorBlock.ondragend = dragEnd;
      profesorBlock.contentEditable = "false";

      let ramoLine = document.createElement('div');
      ramoLine.classList.add('ramo-line');
      ramoLine.contentEditable = "true";
      ramoLine.textContent = "Ramo " + (profesorCounter + 1);

      let profLine = document.createElement('div');
      profLine.classList.add('prof-line');
      profLine.contentEditable = "true";
      profLine.textContent = "Prof. " + (++profesorCounter);

      let colorIcon = document.createElement('img');
      colorIcon.src = 'https://cdn-icons-png.flaticon.com/512/2917/2917995.png';
      colorIcon.classList.add("color-icon");
      colorIcon.title = 'Cambiar color';
      colorIcon.onclick = (ev) => {
        profSeleccionado = profesorBlock;
        colorPicker.style.display = 'block';
        colorPicker.style.left = ev.pageX + 'px';
        colorPicker.style.top = ev.pageY + 'px';
        ev.stopPropagation();
      };

      profesorBlock.appendChild(ramoLine);
      profesorBlock.appendChild(profLine);
      profesorBlock.appendChild(colorIcon);

      // Input de número de bloques (por defecto 1), debajo
      let blockCountInput = document.createElement('input');
      blockCountInput.type = 'number';
      blockCountInput.value = '1';
      blockCountInput.min = '1';
      blockCountInput.style.width = '40px';
      blockCountInput.style.marginTop = '5px';
      blockCountInput.title = 'Nro. de bloques a asignar';

      // Incluir ambos en el "profesorItem"
      profesorItem.appendChild(profesorBlock);
      profesorItem.appendChild(blockCountInput);

      // Agregarlo al contenedor de profesores
      let profesorContainer = document.getElementById('profesorContainer');
      profesorContainer.appendChild(profesorItem);
    }

    // Drag and Drop
    let draggedFromContainer = false;

    function dragStart(event) {
      // Habilitar el "copy" en vez de "move", para no quitar el original del contenedor
      event.dataTransfer.effectAllowed = "copy";
      event.dataTransfer.setData('text/plain', event.target.id);

      draggedFromContainer = (this.parentNode && this.parentNode.classList.contains('profesor-item'));
      // Asegurar que cada profesorBlock tenga un ID único
      if (!this.id) {
        this.id = 'prof_' + Date.now();
      }
      profSeleccionado = this;
    }

    function dragEnd() {
      // Revisa todas las tablas de todos los días
      dias.forEach(d => checkAllRowsForConflicts(d));
    }

    function allowDrop(ev) {
      // Indicar que permitimos soltar (copy)
      ev.preventDefault();
      ev.dataTransfer.dropEffect = "copy";
    }

    /*
      drop(ev, dia):
        - Si viene del contenedor (draggedFromContainer==true), clonarlo (sin ícono color).
          El original permanece en el contenedor.
        - Si viene desde otra celda, moverlo tal cual.
    */
    function drop(ev, dia) {
      ev.preventDefault();
      const id = ev.dataTransfer.getData('text/plain');
      const element = document.getElementById(id);
      if (!element) return;

      if (draggedFromContainer) {
        // Clonamos
        const clone = element.cloneNode(true);
        clone.id = 'prof_' + Date.now() + '_clone';
        clone.draggable = true;
        clone.ondragstart = dragStart;
        clone.ondragend = dragEnd;

        // Quitar ícono de color (si existe)
        let icon = clone.querySelector('.color-icon');
        if (icon) {
          icon.remove();
        }
        // Insertar el clon en la celda
        ev.target.appendChild(clone);
      } else {
        // Si se arrastra desde otra celda, simplemente mover
        ev.target.appendChild(element);
      }

      draggedFromContainer = false;
      // Revisar conflictos en la fila
      let row = ev.target.closest('tr');
      if (row) {
        checkRowConflicts(row);
      }
    }

    // Cambiar color
    function cambiarColor(e) {
      if (profSeleccionado) {
        profSeleccionado.style.backgroundColor = e.target.value;
      }
      colorPicker.style.display = 'none';
    }

    // Cerrar colorPicker si clic fuera
    document.addEventListener('click', (ev) => {
      if (
        colorPicker.style.display === 'block' &&
        !colorPicker.contains(ev.target) &&
        profSeleccionado && 
        !profSeleccionado.contains(ev.target)
      ) {
        colorPicker.style.display = 'none';
        profSeleccionado = null;
      }
    });

    // Evitar arrastrar colorPicker
    colorPicker.ondragstart = (event) => {
      event.preventDefault();
    };

    // Revisar conflictos en la fila
    function checkRowConflicts(row) {
      let tds = row.querySelectorAll('td');
      tds.forEach(td => td.style.backgroundColor = "");
      let profesorMap = new Map();

      tds.forEach(td => {
        let blocks = td.querySelectorAll('.profesor-block');
        blocks.forEach(block => {
          let profLine = block.querySelector('.prof-line');
          if (profLine) {
            let nombreProf = profLine.textContent.trim().toLowerCase();
            if (!profesorMap.has(nombreProf)) {
              profesorMap.set(nombreProf, []);
            }
            profesorMap.get(nombreProf).push(td);
          }
        });
      });

      profesorMap.forEach(celdas => {
        if (celdas.length > 1) {
          celdas.forEach(td => {
            td.style.backgroundColor = 'red';
          });
        }
      });
    }

    // Revisar tabla completa de un día
    function checkAllRowsForConflicts(dia) {
      let filas = document.querySelectorAll(`#cuerpoTabla-${dia} tr`);
      filas.forEach(fila => checkRowConflicts(fila));
    }

    // Guardar en Excel la tabla de un día
    function guardarExcel(dia) {
      let tabla = document.getElementById(`tablaHorarios-${dia}`);
      let wb = XLSX.utils.table_to_book(tabla, { sheet: `Horario-${dia}` });
      XLSX.writeFile(wb, `horario-${dia}.xlsx`);
    }
  </script>
</body>
</html>