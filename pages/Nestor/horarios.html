<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>NestorBOT - Horarios</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    .header-titulo {
      text-align: center;
      background-color: #4b286d;
      color: #fff;
      padding: 15px 0;
      font-size: 1.3rem;
      margin-bottom: 10px;
    }

    /* Sidebar a la izquierda */
    .sidebar-izquierda {
      width: 150px;
      float: left;
      padding: 10px;
      margin-left: 10px;
      background-color: #f8f8f8;
      border-right: 1px solid #ccc;
      min-height: 100vh;
    }
    .sidebar-boton {
      display: block;
      width: 100%;
      margin-bottom: 10px;
      text-align: center;
      text-decoration: none;
      border: 1px solid #aaa;
      border-radius: 5px;
      padding: 8px 0;
      color: #333;
      font-weight: bold;
      background-color: #eee;
      cursor: pointer;
    }
    .sidebar-boton-seleccionado {
      background-color: #75BBB0;
      color: #fff;
      border: none;
    }
    .sidebar-boton:hover {
      background-color: #65A4E3;
      color: #fff;
    }
    .contenedor-principal {
      margin-left: 180px;
      padding: 20px;
      display: flex;
    }

    /* Contenedor principal para la sección de Horarios */
    .horarios-contenedor {
      border: 1px solid #aaa;
      border-radius: 5px;
      padding: 10px;
      margin-top: 20px;
      width: 80%;
      margin-right: 20px;
    }
    .horarios-contenedor h2 {
      margin: 0 0 10px 0;
      font-size: 1.3rem;
      background-color: #4b286d;
      color: #fff;
      padding: 8px;
      border-radius: 4px;
      text-align: center;
    }

    .contenedor-botones-horarios {
      width: 100%;
      text-align: right;
      margin-bottom: 10px;
    }
    .boton-agregar {
      background-color: #75BBB0;
      border: none;
      color: #fff;
      font-size: 1rem;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 5px;
    }
    .boton-agregar:hover {
      background-color: #65A4E3;
    }

    .tabla-horarios {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
      table-layout: fixed;
    }
    .tabla-horarios th,
    .tabla-horarios td {
      border: 1px solid #ccc;
      padding: 6px;
      vertical-align: top;
      position: relative;
      text-align: center; /* Alinear el contenido al centro */
    }
    .col-hora {
      width: 15%;
      text-align: center;
      font-size: 0.7em;
    }
    .tabla-horarios thead th {
      font-size: 0.5em;
    }

    .editable {
      outline: 1px dotted transparent;
    }
    .editable:focus {
      outline: 1px dotted #aaa;
    }

    /* Bloques profesor */
    .profesor-block {
      background-color: #FFD700;
      margin: 5px;
      border: 1px solid #aaa;
      border-radius: 4px;
      padding: 4px 6px;
      font-size: 0.5em;
      cursor: move;
      position: relative;
      user-select: none; /* Prevent text selection while dragging */
      display: inline-block;
    }
    /* Internamente habrá 2 divs editables (ramo y profesor),
       y el ícono para el color (no editable). */
    .profesor-block .ramo-line,
    .profesor-block .prof-line {
      display: block;
      width: 100%;
      min-height: 12px; /* ayuda a ver el recuadro cuando está vacío */
      border-bottom: 1px dashed transparent;
    }

    .profesor-block img.color-icon {
      width: 12px;
      height: 12px;
      margin-left: 5px;
      cursor: pointer;
      display: inline-block;
      vertical-align: middle;
    }

    /* colorPicker tooltip */
    #colorPicker {
      display: none;
      position: absolute;
      z-index: 9999;
    }

    /* Enlace de retorno */
    .btn-regresar {
      display: inline-block;
      margin-top: 10px;
      margin-right: 10px;
      padding: 6px 12px;
      background-color: #ccc;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      color: #333;
    }
    .btn-regresar:hover {
      background-color: #bbb;
    }

    /* Container for professor blocks */
    #profesorContainer {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-top: 20px;
      width: 200px; /* Ajustar según tus necesidades */
    }
    #profesorContainer button.boton-agregar {
      width: 100%;
      margin-bottom: 10px;
    }

    /* Fila de recreo en gris */
    .recreo td {
      background-color: #eee !important;
    }
  </style>
</head>
<body>
  <div class="header-titulo">NestorBOT v2.0 - Horarios</div>

  <!-- Sidebar Izquierda -->
  <div class="sidebar-izquierda">
    <a href="conversor.html" class="sidebar-boton">Conversor</a>
    <a class="sidebar-boton sidebar-boton-seleccionado">Horarios</a>
    <a class="sidebar-boton" href="index.html">Menú Principal</a>
  </div>

  <div class="contenedor-principal">
    <div class="horarios-contenedor">
      <h2>Horario General</h2>
      <div class="contenedor-botones-horarios">
        <!-- Botón para agregar columnas -->
        <button class="boton-agregar" onclick="agregarColumna()">Agregar Curso</button>
        <!-- Botón para guardar el horario en Excel -->
        <button class="boton-agregar" onclick="guardarExcel()">Guardar Excel</button>
      </div>
      <table class="tabla-horarios" id="tablaHorarios">
        <thead>
          <tr id="filaCabeceras">
            <th class="col-hora">Hora</th>
          </tr>
        </thead>
        <tbody id="cuerpoTabla"></tbody>
      </table>
    </div>
    <div id="profesorContainer">
      <button class="boton-agregar" onclick="crearProfesor()">Agregar Profe</button>
    </div>
  </div>

  <!-- colorPicker para cambiar color al profesor -->
  <input type="color" id="colorPicker" oninput="cambiarColor(event)" onclick="event.stopPropagation()" />

  <!-- Librería para exportar a Excel (SheetJS) -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <script>
    /*
      1) Ajuste de horas y recreos:
         - Bloques de 45 min a partir de las 8:15.
         - Recreos en:
             9:45 - 10:00
             11:30 - 11:45
             13:15 - 14:00
             15:30 - 15:45
         - Termina alrededor de las 19:00.
    */
    const BLOQUES = [
      // Bloques normales (no recreo)
      { label: "08:15", isBreak: false },
      { label: "09:00", isBreak: false },
      // Recreo
      { label: "09:45 - 10:00 (Recreo)", isBreak: true },
      // Bloques
      { label: "10:00", isBreak: false },
      { label: "10:45", isBreak: false },
      // Recreo
      { label: "11:30 - 11:45 (Recreo)", isBreak: true },
      // Bloques
      { label: "11:45", isBreak: false },
      { label: "12:30", isBreak: false },
      // Recreo
      { label: "13:15 - 14:00 (Recreo)", isBreak: true },
      // Bloques
      { label: "14:00", isBreak: false },
      { label: "14:45", isBreak: false },
      // Recreo
      { label: "15:30 - 15:45 (Recreo)", isBreak: true },
      // Bloques
      { label: "15:45", isBreak: false },
      { label: "16:30", isBreak: false },
      { label: "17:15", isBreak: false },
      { label: "18:00", isBreak: false },
      { label: "18:45 - 19:00", isBreak: false }
    ];

    function generarHoras() {
      let cuerpo = document.getElementById('cuerpoTabla');
      BLOQUES.forEach(b => {
        let fila = document.createElement('tr');
        // Si es recreo, marcamos la fila con la clase .recreo
        if (b.isBreak) {
          fila.classList.add('recreo');
        }
        let tdHora = document.createElement('td');
        tdHora.classList.add('col-hora');
        tdHora.style.pointerEvents = 'none';
        tdHora.textContent = b.label;
        fila.appendChild(tdHora);
        cuerpo.appendChild(fila);
      });
    }
    generarHoras();

    // Agregar Columna = "Nuevo Curso"
    // Si una fila es de recreo, se deja SIN eventos de Drop/DragOver.
    function agregarColumna() {
      let filaCabeceras = document.getElementById('filaCabeceras');
      let nuevoTh = document.createElement('th');
      nuevoTh.classList.add('editable');
      nuevoTh.contentEditable = "true";
      nuevoTh.textContent = 'Nuevo Curso';
      filaCabeceras.appendChild(nuevoTh);

      let cuerpo = document.getElementById('cuerpoTabla');
      let filas = cuerpo.getElementsByTagName('tr');
      for (let i = 0; i < filas.length; i++) {
        let nuevaTd = document.createElement('td');
        // Si la fila es recreo, no permitimos drop
        if (!filas[i].classList.contains('recreo')) {
          nuevaTd.ondragover = allowDrop;
          nuevaTd.ondrop = drop;
        }
        filas[i].appendChild(nuevaTd);
      }
    }

    // Crear profesor. Ahora tendrá 2 líneas:
    //  1) Ramo
    //  2) Nombre del profesor
    // Más el ícono de color (fuera de la parte editable)
    let colorPicker = document.getElementById('colorPicker');
    let profSeleccionado = null;
    let profesorCounter = 0;

    function crearProfesor() {
      // Contenedor principal
      let profesorBlock = document.createElement('div');
      profesorBlock.classList.add('profesor-block');
      profesorBlock.draggable = true;
      profesorBlock.ondragstart = dragStart;
      // Asignamos un dragend para re-chequear conflictos
      profesorBlock.ondragend = dragEnd;

      // Evitamos que todo el bloque sea editable de golpe
      profesorBlock.contentEditable = "false";

      // Primera línea (nombre del ramo)
      let ramoLine = document.createElement('div');
      ramoLine.classList.add('ramo-line');
      ramoLine.contentEditable = "true";
      ramoLine.textContent = "Ramo " + (profesorCounter + 1);

      // Segunda línea (nombre del profesor)
      let profLine = document.createElement('div');
      profLine.classList.add('prof-line');
      profLine.contentEditable = "true";
      profLine.textContent = "Prof. " + (++profesorCounter);

      // Ícono para cambiar color
      let colorIcon = document.createElement('img');
      colorIcon.src = 'https://cdn-icons-png.flaticon.com/512/2917/2917995.png';
      colorIcon.classList.add("color-icon");
      colorIcon.title = 'Cambiar color';
      colorIcon.onclick = (ev) => {
        profSeleccionado = profesorBlock;
        colorPicker.style.display = 'block';
        colorPicker.style.left = ev.pageX + 'px';
        colorPicker.style.top = ev.pageY + 'px';
        ev.stopPropagation();
      };

      // Insertar todo en el bloque
      profesorBlock.appendChild(ramoLine);
      profesorBlock.appendChild(profLine);
      profesorBlock.appendChild(colorIcon);

      // Insertarlo en el contenedor de profesores
      let profesorContainer = document.getElementById('profesorContainer');
      profesorContainer.appendChild(profesorBlock);
    }

    // Drag and Drop functions
    let draggedFromContainer = false;

    function dragStart(event) {
      event.dataTransfer.setData('text/plain', event.target.id);
      draggedFromContainer = (this.parentNode.id === 'profesorContainer');

      // Si el bloque no tiene id, asignarle uno
      if (!this.id) {
        this.id = 'prof_' + Date.now();
      }
      profSeleccionado = this; // Seleccionamos el profesor que se está arrastrando
    }

    function dragEnd() {
      checkAllRowsForConflicts();
    }

    function allowDrop(ev) {
      ev.preventDefault();
    }

    function drop(ev) {
      ev.preventDefault();
      const id = ev.dataTransfer.getData('text/plain');
      const element = document.getElementById(id);

      if (element) {
        // Si viene desde el contenedor original, clonarlo
        if (draggedFromContainer) {
          const clone = element.cloneNode(true);
          clone.id = 'prof_' + Date.now() + '_clone'; // Nuevo ID para el clon
          clone.draggable = true;
          clone.ondragstart = dragStart;
          clone.ondragend = dragEnd; // Re-asignar el dragend al clon
          // Conectar de nuevo el evento del ícono de color
          let colorIcon = clone.querySelector('img.color-icon');
          if (colorIcon) {
            colorIcon.onclick = (e) => {
              profSeleccionado = clone;
              colorPicker.style.display = 'block';
              colorPicker.style.left = e.pageX + 'px';
              colorPicker.style.top = e.pageY + 'px';
              e.stopPropagation();
            };
          }
          ev.target.appendChild(clone);
        } else if (ev.target.tagName === 'TD') {
          // Si simplemente se está moviendo dentro de la tabla
          ev.target.appendChild(element);
        }
        draggedFromContainer = false;
      }

      let row = ev.target.closest('tr');
      if (row) {
        checkRowConflicts(row);
      }
    }

    // Cambiar color
    function cambiarColor(e) {
      if (profSeleccionado) {
        profSeleccionado.style.backgroundColor = e.target.value;
      }
      colorPicker.style.display = 'none';
    }

    // Ocultar colorPicker al hacer click fuera
    document.addEventListener('click', (ev) => {
      if (colorPicker.style.display === 'block' &&
          !colorPicker.contains(ev.target) &&
          profSeleccionado && 
          !profSeleccionado.contains(ev.target)) {
        colorPicker.style.display = 'none';
        profSeleccionado = null;
      }
    });

    // Evitar arrastrar el colorPicker
    colorPicker.ondragstart = (event) => {
      event.preventDefault();
    };

    //------------------------------------------
    // Revisar conflictos en la fila (misma hora)
    // Si un mismo profesor aparece en <td> distintos,
    // esos <td> se colorean de rojo.
    //------------------------------------------
    function checkRowConflicts(row) {
      let tds = row.querySelectorAll('td');

      // Limpia el color previo de cada <td>
      tds.forEach(td => td.style.backgroundColor = "");

      // Mapeo { nombreProfesor -> [td, td, ...] }
      let profesorMap = new Map();

      tds.forEach(td => {
        let blocks = td.querySelectorAll('.profesor-block');
        blocks.forEach(block => {
          let profLine = block.querySelector('.prof-line');
          if (profLine) {
            let nombreProf = profLine.textContent.trim().toLowerCase();
            if (!profesorMap.has(nombreProf)) {
              profesorMap.set(nombreProf, []);
            }
            profesorMap.get(nombreProf).push(td);
          }
        });
      });

      // Conflicto: mismo prof en 2+ celdas
      profesorMap.forEach(celdas => {
        if (celdas.length > 1) {
          celdas.forEach(td => {
            td.style.backgroundColor = 'red';
          });
        }
      });
    }

    //------------------------------------------
    // checkAllRowsForConflicts: Revisa cada fila de la tabla
    //------------------------------------------
    function checkAllRowsForConflicts() {
      let filas = document.querySelectorAll('#cuerpoTabla tr');
      filas.forEach(fila => checkRowConflicts(fila));
    }

    //------------------------------------------
    // Guardar en Excel
    //------------------------------------------
    function guardarExcel() {
      // Convertir la tabla a libro Excel con SheetJS
      let tabla = document.getElementById("tablaHorarios");
      let wb = XLSX.utils.table_to_book(tabla, { sheet: "Horario" });
      // Guardar el archivo
      XLSX.writeFile(wb, "horario.xlsx");
    }
  </script>
</body>
</html>