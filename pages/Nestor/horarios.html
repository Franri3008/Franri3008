<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>NestorBOT - Horarios</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    .header-titulo {
      text-align: center;
      background-color: #4b286d;
      color: #fff;
      padding: 15px 0;
      font-size: 1.3rem;
      margin-bottom: 10px;
    }

    /* Barra superior con botones de días */
    .top-dias {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 10px;
    }
    .top-dias button {
      margin: 0 5px;
      padding: 6px 12px;
      cursor: pointer;
      background-color: #bbb;
      border: none;
      border-radius: 5px;
      color: #fff;
      font-weight: bold;
    }
    .top-dias button:hover {
      background-color: #999;
    }
    /* Botón de día activo */
    .top-dias button.activo {
      background-color: #666;
    }

    /* Sidebar a la izquierda */
    .sidebar-izquierda {
      width: 150px;
      float: left;
      padding: 10px;
      margin-left: 10px;
      background-color: #f8f8f8;
      border-right: 1px solid #ccc;
      min-height: 100vh;
    }
    .sidebar-boton {
      display: block;
      width: 100%;
      margin-bottom: 10px;
      text-align: center;
      text-decoration: none;
      border: 1px solid #aaa;
      border-radius: 5px;
      padding: 8px 0;
      color: #333;
      font-weight: bold;
      background-color: #eee;
      cursor: pointer;
    }
    .sidebar-boton-seleccionado {
      background-color: #75BBB0;
      color: #fff;
      border: none;
    }
    .sidebar-boton:hover {
      background-color: #65A4E3;
      color: #fff;
    }

    .contenedor-principal {
      margin-left: 180px;
      padding: 20px;
      /* No forzamos display:block para no interferir con la visibilidad de los días */
    }

    /* Contenedor principal para la sección de Horarios */
    .horarios-contenedor {
      border: 1px solid #aaa;
      border-radius: 5px;
      padding: 10px;
      margin-top: 20px;
      margin-bottom: 20px;
      width: 90%;
    }
    .horarios-contenedor h2 {
      margin: 0 0 10px 0;
      font-size: 1.3rem;
      background-color: #4b286d;
      color: #fff;
      padding: 8px;
      border-radius: 4px;
      text-align: center;
    }

    .contenedor-botones-horarios {
      width: 100%;
      text-align: right;
      margin-bottom: 10px;
    }
    .boton-agregar {
      background-color: #75BBB0;
      border: none;
      color: #fff;
      font-size: 1rem;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 5px;
    }
    .boton-agregar:hover {
      background-color: #65A4E3;
    }

    .tabla-horarios {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
      table-layout: fixed;
    }
    .tabla-horarios th,
    .tabla-horarios td {
      border: 1px solid #ccc;
      padding: 6px;
      vertical-align: top;
      position: relative;
      text-align: center;
    }
    .col-hora {
      width: 15%;
      text-align: center;
      font-size: 0.7em;
    }
    .tabla-horarios thead th {
      font-size: 0.5em;
    }

    .editable {
      outline: 1px dotted transparent;
    }
    .editable:focus {
      outline: 1px dotted #aaa;
    }

    /* Bloques profesor: centrado de texto en su interior */
    .profesor-block {
      background-color: #FFD700;
      margin: 5px;
      border: 1px solid #aaa;
      border-radius: 4px;
      padding: 4px 6px;
      font-size: 0.5em;
      cursor: move;
      position: relative;
      user-select: none; 
      display: inline-block;
      text-align: center; /* Centra el texto dentro del bloque */
    }
    .profesor-block .ramo-line,
    .profesor-block .prof-line {
      display: block;
      width: 100%;
      min-height: 12px;
    }

    /* celdas de recreo en gris, altura menor (x0.2 aprox) */
    .recreo td {
      background-color: #eee !important;
      line-height: 0.2;
      height: 0.2em;
      min-height: 1px;
    }

    /* colorPicker tooltip */
    #colorPicker {
      display: none;
      position: absolute;
      z-index: 9999;
    }

    /* Container para los profesores: horizontal flex-wrap */
    #profesorContainer {
      display: flex;
      flex-wrap: wrap; /* Para que bajen a la siguiente línea si son muchos */
      margin-top: 20px;
      width: 95%;
      border: 1px dashed #ccc;
      padding: 10px;
    }
    #profesorContainer button.boton-agregar {
      width: auto;
      margin-bottom: 10px;
    }

    /* item que contiene al block y elementos debajo (color, eliminar, input) */
    .profesor-item {
      display: flex;
      flex-direction: column; 
      align-items: flex-start;
      margin-right: 15px;
      margin-bottom: 15px;
    }

    .profesor-item-icons {
      margin-top: 5px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: center;  /* Centra los íconos horizontalmente */
      justify-content: center;
    }

    /* Hacemos los íconos de 15x15 y centrados */
    .profesor-item-icons img {
      width: 15px;
      height: 15px;
      cursor: pointer;
      display: inline-block;
      user-select: none;
    }
    .profesor-item-icons img:hover {
      opacity: 0.7;
    }

    /* Cada día se esconde por defecto, se muestra al estar activo */
    .dia-contenedor {
      display: none !important;
    }
    .dia-contenedor.activo {
      display: block !important;
    }
  </style>
</head>
<body>
  <div class="header-titulo">NestorBOT v2.0 - Horarios</div>

  <!-- Barra superior con 5 botones de días -->
  <div class="top-dias">
    <button id="btn-lunes" onclick="mostrarDia('lunes')">Lunes</button>
    <button id="btn-martes" onclick="mostrarDia('martes')">Martes</button>
    <button id="btn-miercoles" onclick="mostrarDia('miercoles')">Miércoles</button>
    <button id="btn-jueves" onclick="mostrarDia('jueves')">Jueves</button>
    <button id="btn-viernes" onclick="mostrarDia('viernes')">Viernes</button>
  </div>

  <!-- Sidebar Izquierda -->
  <div class="sidebar-izquierda">
    <a href="conversor.html" class="sidebar-boton">Conversor</a>
    <a class="sidebar-boton sidebar-boton-seleccionado">Horarios</a>
    <a class="sidebar-boton" href="index.html">Menú Principal</a>
  </div>

  <div class="contenedor-principal">
    <!-- Cada día es un contenedor distinto (por defecto oculto, salvo el activo) -->
    <div id="dia-lunes" class="dia-contenedor">
      <div class="horarios-contenedor">
        <h2>Horario Lunes</h2>
        <div class="contenedor-botones-horarios">
          <button class="boton-agregar" onclick="agregarColumna()">Agregar Curso</button>
          <button class="boton-agregar" onclick="guardarExcel('lunes')">Guardar Excel</button>
        </div>
        <table class="tabla-horarios" id="tablaHorarios-lunes">
          <thead>
            <tr id="filaCabeceras-lunes">
              <th class="col-hora">Hora</th>
            </tr>
          </thead>
          <tbody id="cuerpoTabla-lunes"></tbody>
        </table>
      </div>
    </div>

    <div id="dia-martes" class="dia-contenedor">
      <div class="horarios-contenedor">
        <h2>Horario Martes</h2>
        <div class="contenedor-botones-horarios">
          <button class="boton-agregar" onclick="agregarColumna()">Agregar Curso</button>
          <button class="boton-agregar" onclick="guardarExcel('martes')">Guardar Excel</button>
        </div>
        <table class="tabla-horarios" id="tablaHorarios-martes">
          <thead>
            <tr id="filaCabeceras-martes">
              <th class="col-hora">Hora</th>
            </tr>
          </thead>
          <tbody id="cuerpoTabla-martes"></tbody>
        </table>
      </div>
    </div>

    <div id="dia-miercoles" class="dia-contenedor">
      <div class="horarios-contenedor">
        <h2>Horario Miércoles</h2>
        <div class="contenedor-botones-horarios">
          <button class="boton-agregar" onclick="agregarColumna()">Agregar Curso</button>
          <button class="boton-agregar" onclick="guardarExcel('miercoles')">Guardar Excel</button>
        </div>
        <table class="tabla-horarios" id="tablaHorarios-miercoles">
          <thead>
            <tr id="filaCabeceras-miercoles">
              <th class="col-hora">Hora</th>
            </tr>
          </thead>
          <tbody id="cuerpoTabla-miercoles"></tbody>
        </table>
      </div>
    </div>

    <div id="dia-jueves" class="dia-contenedor">
      <div class="horarios-contenedor">
        <h2>Horario Jueves</h2>
        <div class="contenedor-botones-horarios">
          <button class="boton-agregar" onclick="agregarColumna()">Agregar Curso</button>
          <button class="boton-agregar" onclick="guardarExcel('jueves')">Guardar Excel</button>
        </div>
        <table class="tabla-horarios" id="tablaHorarios-jueves">
          <thead>
            <tr id="filaCabeceras-jueves">
              <th class="col-hora">Hora</th>
            </tr>
          </thead>
          <tbody id="cuerpoTabla-jueves"></tbody>
        </table>
      </div>
    </div>

    <div id="dia-viernes" class="dia-contenedor">
      <div class="horarios-contenedor">
        <h2>Horario Viernes</h2>
        <div class="contenedor-botones-horarios">
          <button class="boton-agregar" onclick="agregarColumna()">Agregar Curso</button>
          <button class="boton-agregar" onclick="guardarExcel('viernes')">Guardar Excel</button>
        </div>
        <table class="tabla-horarios" id="tablaHorarios-viernes">
          <thead>
            <tr id="filaCabeceras-viernes">
              <th class="col-hora">Hora</th>
            </tr>
          </thead>
          <tbody id="cuerpoTabla-viernes"></tbody>
        </table>
      </div>
    </div>

    <!-- Contenedor de profesores (abajo) -->
    <div id="profesorContainer">
      <button class="boton-agregar" onclick="crearProfesor()">Agregar Profe</button>
    </div>
  </div>

  <!-- colorPicker para cambiar color al profesor -->
  <input type="color" id="colorPicker" oninput="cambiarColor(event)" onclick="event.stopPropagation()" />

  <!-- Librería para exportar a Excel (SheetJS) -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <script>
    /*
      1) Se muestra un solo día a la vez.
      2) Íconos de color y basurero de 15x15, centrados en su contenedor.
      3) Texto dentro de cada bloque profesor está centrado.
      4) Columnas globales para todos los días.
    */

    const BLOQUES = [
      { label: "08:15", isBreak: false },
      { label: "09:00", isBreak: false },
      { label: "",      isBreak: true  }, // 9:45-10:00
      { label: "10:00", isBreak: false },
      { label: "10:45", isBreak: false },
      { label: "",      isBreak: true  }, // 11:30-11:45
      { label: "11:45", isBreak: false },
      { label: "12:30", isBreak: false },
      { label: "",      isBreak: true  }, // 13:15-14:00
      { label: "14:00", isBreak: false },
      { label: "14:45", isBreak: false },
      { label: "",      isBreak: true  }, // 15:30-15:45
      { label: "15:45", isBreak: false },
      { label: "16:30", isBreak: false },
      { label: "17:15", isBreak: false },
      { label: "18:00", isBreak: false },
      { label: "18:45", isBreak: false }
    ];

    const dias = ["lunes", "martes", "miercoles", "jueves", "viernes"];
    let columnasGlobales = [];

    window.onload = function(){
      dias.forEach(d => generarHorasParaDia(d));
      mostrarDia("lunes"); // Muestra lunes por defecto 
    };

    function generarHorasParaDia(dia) {
      let cuerpo = document.getElementById(`cuerpoTabla-${dia}`);
      BLOQUES.forEach(b => {
        let fila = document.createElement('tr');
        if (b.isBreak) {
          fila.classList.add('recreo');
        }
        let tdHora = document.createElement('td');
        tdHora.classList.add('col-hora');
        tdHora.style.pointerEvents = 'none';
        tdHora.textContent = b.label; 
        fila.appendChild(tdHora);
        cuerpo.appendChild(fila);
      });
    }

    function mostrarDia(dia) {
      dias.forEach(d => {
        const contenedor = document.getElementById(`dia-${d}`);
        const btnDia = document.getElementById(`btn-${d}`);
        if(d===dia) {
          contenedor.classList.add('activo');
          btnDia.classList.add('activo');
        } else {
          contenedor.classList.remove('activo');
          btnDia.classList.remove('activo');
        }
      });
    }

    function agregarColumna() {
      let nombreCurso = "Nuevo Curso " + (columnasGlobales.length + 1);
      columnasGlobales.push(nombreCurso);

      dias.forEach(dia => {
        let filaCabeceras = document.getElementById(`filaCabeceras-${dia}`);
        let nuevoTh = document.createElement('th');
        nuevoTh.classList.add('editable');
        nuevoTh.contentEditable = "true";
        nuevoTh.textContent = nombreCurso;
        filaCabeceras.appendChild(nuevoTh);

        let cuerpo = document.getElementById(`cuerpoTabla-${dia}`);
        let filas = cuerpo.getElementsByTagName('tr');
        for (let i = 0; i < filas.length; i++) {
          let nuevaTd = document.createElement('td');
          if (!filas[i].classList.contains('recreo')) {
            nuevaTd.ondragover = allowDrop;
            nuevaTd.ondrop = (ev) => drop(ev, dia);
          }
          filas[i].appendChild(nuevaTd);
        }
      });
    }

    let colorPicker = document.getElementById('colorPicker');
    let profSeleccionado = null;
    let profesorCounter = 0;

    function crearProfesor() {
      let profesorItem = document.createElement('div');
      profesorItem.classList.add('profesor-item');

      // Bloque con 2 líneas
      let profesorBlock = document.createElement('div');
      profesorBlock.classList.add('profesor-block');
      profesorBlock.draggable = true;
      profesorBlock.ondragstart = dragStart;
      profesorBlock.ondragend = dragEnd;
      profesorBlock.contentEditable = "false";

      let ramoLine = document.createElement('div');
      ramoLine.classList.add('ramo-line');
      ramoLine.contentEditable = "true";
      ramoLine.textContent = "Ramo " + (profesorCounter + 1);

      let profLine = document.createElement('div');
      profLine.classList.add('prof-line');
      profLine.contentEditable = "true";
      profLine.textContent = "Prof. " + (++profesorCounter);

      profesorBlock.appendChild(ramoLine);
      profesorBlock.appendChild(profLine);

      // Contenedor de íconos (color + basura) centrados
      let iconContainer = document.createElement('div');
      iconContainer.classList.add('profesor-item-icons');

      let colorIcon = document.createElement('img');
      colorIcon.src = 'https://cdn-icons-png.flaticon.com/512/2917/2917995.png';
      colorIcon.title = 'Cambiar color';
      colorIcon.onclick = (ev) => {
        profSeleccionado = profesorBlock;
        colorPicker.style.display = 'block';
        colorPicker.style.left = ev.pageX + 'px';
        colorPicker.style.top = ev.pageY + 'px';
        ev.stopPropagation();
      };

      let trashIcon = document.createElement('img');
      trashIcon.src = 'https://cdn-icons-png.flaticon.com/512/3096/3096673.png';
      trashIcon.title = 'Eliminar profesor';
      trashIcon.onclick = () => {
        profesorItem.remove();
      };

      iconContainer.appendChild(colorIcon);
      iconContainer.appendChild(trashIcon);

      // Input de número de bloques
      let blockCountInput = document.createElement('input');
      blockCountInput.type = 'number';
      blockCountInput.value = '1';
      blockCountInput.min = '1';
      blockCountInput.style.width = '40px';
      blockCountInput.title = 'Nro. de bloques a asignar';
      blockCountInput.style.marginTop = '5px';

      // Agregar elementos al contenedor del profesor
      profesorItem.appendChild(profesorBlock);
      profesorItem.appendChild(iconContainer);
      profesorItem.appendChild(blockCountInput);

      let profesorContainer = document.getElementById('profesorContainer');
      profesorContainer.appendChild(profesorItem);
    }

    let draggedFromContainer = false;
    function dragStart(event) {
      event.dataTransfer.effectAllowed = "copy"; 
      event.dataTransfer.setData('text/plain', event.target.id);

      draggedFromContainer = (
        this.parentNode &&
        this.parentNode.classList &&
        this.parentNode.classList.contains('profesor-item')
      );
      if (!this.id) {
        this.id = 'prof_' + Date.now();
      }
      profSeleccionado = this;
    }

    function dragEnd() {
      dias.forEach(d => checkAllRowsForConflicts(d));
    }

    function allowDrop(ev) {
      ev.preventDefault();
      ev.dataTransfer.dropEffect = "copy";
    }

    function drop(ev, dia) {
      ev.preventDefault();
      const id = ev.dataTransfer.getData('text/plain');
      const element = document.getElementById(id);
      if (!element) return;

      if (draggedFromContainer) {
        // Clonamos
        const clone = element.cloneNode(true);
        clone.id = 'prof_' + Date.now() + '_clone';
        clone.draggable = true;
        clone.ondragstart = dragStart;
        clone.ondragend = dragEnd;
        ev.target.appendChild(clone);
      } else {
        // Mover de una celda a otra
        ev.target.appendChild(element);
      }

      draggedFromContainer = false;
      let row = ev.target.closest('tr');
      if (row) {
        checkRowConflicts(row);
      }
    }

    function cambiarColor(e) {
      if (profSeleccionado) {
        profSeleccionado.style.backgroundColor = e.target.value;
      }
      colorPicker.style.display = 'none';
    }

    document.addEventListener('click', (ev) => {
      if (
        colorPicker.style.display === 'block' &&
        !colorPicker.contains(ev.target) &&
        profSeleccionado && 
        !profSeleccionado.contains(ev.target)
      ) {
        colorPicker.style.display = 'none';
        profSeleccionado = null;
      }
    });

    colorPicker.ondragstart = (event) => {
      event.preventDefault();
    };

    function checkRowConflicts(row) {
      let tds = row.querySelectorAll('td');
      tds.forEach(td => td.style.backgroundColor = "");
      let profesorMap = new Map();

      tds.forEach(td => {
        let blocks = td.querySelectorAll('.profesor-block');
        blocks.forEach(block => {
          let profLine = block.querySelector('.prof-line');
          if (profLine) {
            let nombreProf = profLine.textContent.trim().toLowerCase();
            if (!profesorMap.has(nombreProf)) {
              profesorMap.set(nombreProf, []);
            }
            profesorMap.get(nombreProf).push(td);
          }
        });
      });

      profesorMap.forEach(celdas => {
        if (celdas.length > 1) {
          celdas.forEach(td => {
            td.style.backgroundColor = 'red';
          });
        }
      });
    }

    function checkAllRowsForConflicts(dia) {
      let filas = document.querySelectorAll(`#cuerpoTabla-${dia} tr`);
      filas.forEach(fila => checkRowConflicts(fila));
    }

    function guardarExcel(dia) {
      let tabla = document.getElementById(`tablaHorarios-${dia}`);
      let wb = XLSX.utils.table_to_book(tabla, { sheet: `Horario-${dia}` });
      XLSX.writeFile(wb, `horario-${dia}.xlsx`);
    }
  </script>
</body>
</html>